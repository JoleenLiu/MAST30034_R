---
title: "Lab2 tutorial"
date: "`r Sys.Date()`"
author: Yue You
output:
  rmdformats::html_clean:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---


### Lab 2 Overview

#### First Half

More Visualisations:

* ggplot2 (ggmap)

* HexBins vs SquareBins

* Choropleths

Descriptive Statistics:

* Histograms and looking at the distribution shape.

* How to "quick plot" dataframes using ggplot2.

A brief summary:



#### Second Half

Revision:

* Any code related questions for R

**Let's get started**


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load libraries
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(sf)
library(curl)
library(ggmap)
library(tmap)
library(tmaptools)
library(feather)
```

Load data
```{r}
#try feather 
filepath = "../data/df.feather"
df <- read_feather(filepath)
df %>% tail
```

### ggplot2

Itâ€™s hard to succinctly describe how **ggplot2** works because it embodies a deep philosophy of visualisation. However, in most cases you start with ggplot(), supply a dataset and aesthetic mapping (with aes()). You then add on layers (like geom_point() or geom_histogram()), scales (like scale_colour_brewer()), faceting specifications (like facet_wrap()) and coordinate systems (like coord_flip()).

```{r}
library(ggplot2)
ggplot(df, aes(total_amount, trip_distance, colour = as.factor(payment_type))) + 
  geom_point()
```

In spatial statistics the ability to visualize data and models superimposed with their basic
social landmarks and geographic context is invaluable. **ggmap** is a new tool which enables visualization by combining the spatial information of static maps from Google Maps, OpenStreetMap, etc., with the layered grammar of graphics implementation of **ggplot2**.

Select the map.

```{r, message=FALSE,warning=FALSE,fig.height = 8, fig.width = 6, fig.align = "center"}
xranges <- range(df$pickup_longitude[!df$pickup_longitude==0])
yranges <- range(df$pickup_latitude[!df$pickup_latitude==0])
xranges
yranges
```


```{r, message=FALSE,warning=FALSE, fig.align = "center"}
map_big <- get_stamenmap(
  rbind(-74.3,40.45,-73.6,40.95), 
  zoom = 10)
ggmap(map_big)
```

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  geom_point(data = df,
             aes(x = dropoff_longitude,
                 y = dropoff_latitude),
             colour="red", size = 0.05) +
  geom_point(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             colour="blue", size = 0.05) 
```


### Heatmaps

* Excellent tool when visualising geospatial coordinates.

Plot pickup locations.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  geom_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) 
```

Change the color scale.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) +
  scale_fill_viridis_c(trans = "log10")
```

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) +
  scale_fill_gradientn(colours = c("darkred", "orange", "yellow", "white"),trans="log10")
```

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) +
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 alpha = 0.95),
             bins=50) +
  scale_fill_gradientn(colours = c("darkred", "orange", "yellow", "white"),trans="log10")
```



Filled by discrete factors.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 fill = as.factor(payment_type)),
             bins=50) 
```

Change the color palette. A good palette makes your story better.

```{r message=FALSE, fig.align = "center"}
library(RColorBrewer)
display.brewer.all()
```
```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 fill = as.factor(payment_type)),
             bins=100) +
  scale_fill_brewer(palette = "Dark2")
```




```{r, message=FALSE, warning=FALSE, fig.align = "center",fig.height=6,fig.width=18}
ggmap(map_big) + 
  stat_bin2d(data=df,
           aes(x = pickup_longitude, y = pickup_latitude),
           alpha = 0.9,
           bins=100) +
  scale_fill_viridis_c(trans = "log10") +
  facet_grid(.~payment_type)
```

Hexagon bins avoid the visual artefacts sometimes generated by the very regular alignment of geom_bin2d().


Plot HexBin.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_binhex(data=df,
           aes(x = pickup_longitude, y = pickup_latitude),
               bins=100) +
  coord_cartesian()  +
  scale_fill_gradient2(trans="log10")
```



### Shapefile Overlays

* **NOTE: This only applies on the more recent datasets that use zones over coordinates**

Requirements:

* ggplot2/ ggmap/ tmap/ leaflet


```{r}
df_yellow = read.csv("../data/yellow_tripdata_2019-01.csv",stringsAsFactors = TRUE)
df_yellow %>% 
  group_by(PULocationID, payment_type) %>% 
  summarise(n = n()) -> df_yellow_summary
```

```{r}
library(sf)
```

Shapefile Links:

A shapefile is a simple, nontopological format for storing the geometric location and attribute information of geographic features. Geographic features in a shapefile can be represented by points, lines, or polygons (areas).

[taxi_zones.zip](https://s3.amazonaws.com/nyc-tlc/misc/taxi_zones.zip)
[taxi+_zone_lookup.csv](https://s3.amazonaws.com/nyc-tlc/misc/taxi+_zone_lookup.csv)

```{r}
sf = st_read("../data/shapefile/taxi_zones/taxi_zones.shp")
zone = read.csv("../data/shapefile/taxi+_zone_lookup.csv")
```

Basic information in shapefile.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
sf = st_read("../data/shapefile/taxi_zones/")
plot(sf)
```

#### Choropleth mapping with ggplot2

```{r  message=FALSE, warning=FALSE, fig.align = "center"}
ggplot() + 
  geom_sf(data = sf, size = 1, color = "black", fill = "cyan1") + 
  ggtitle("Boundary Plot") + 
  coord_sf()+
  theme_bw()
```

#### Adding basemaps with ggmap

```{r  message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) +
    geom_sf(data = sf, aes(fill=Shape_Area), inherit.aes = FALSE)  +
  coord_sf(crs = st_crs(4326)) +
  scale_fill_viridis_c()
```

#### Choropleth with tmap 

tmap is specifically designed to make creation of thematic maps more convenient. It borrows from thw ggplot syntax and takes care of a lot of the styling and aesthetics. This reduces our amount of code significantly. We only need:

* tm_shape() where we provide the sf object (we could also provide an SpatialPolygonsDataframe)

* tm_polygons() where we set the attribute variable to map, the break style, and a title.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
tm_shape(sf)+
   tm_polygons("Shape_Area",style="quantile")
```
Incorporate information we have based on pickup locations to the simple feature collection.

```{r}
sf_join <- 
left_join(sf,df_yellow_summary,
          by=c("LocationID"="PULocationID")) 
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
tm_shape(sf_join)+
   tm_polygons("payment_type",style="cat")
```
```{r}
tmap_mode("view")
tmap_last()
```

Read more about [Reprojecting geographic data](https://geocompr.robinlovelace.net/reproj-geo-data.html).

### Descriptive Statistics

```{r}
filepath = "../data/df.feather"
df <- read_feather(filepath)
```

```{r}
summary(df)
```

Remember that not all the data should be interpreted as purely numerical.
There may be conclusions you can draw by coincidence if you incorrectly assume data types!
For example:

* longitude and latitude should be interpreted as geospatial coordinates

* payment_type is a discrete category of payment types

* trip_distance is non-linear (not a straight line from A to B), but we have no further data on it. It is also in miles.

* To avoid misinterpreting the attributes, refer to the data dictionary provided on the TLC website.

### Scatterplot plots for Fare / Distance

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df) +
  aes(x=fare_amount,y=trip_distance) +
  geom_point()+
  theme_bw()
```

General Inference:

* We can visually see that the relationship is relatively linear as you'd expect (more distance generally means more money)
* A fair number of outliers, notably around the 0 distance axis and 0 cost axis. Why might this be the case?
* Why are there negative values?



### Histgram plots for Fare amount

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df)+
  geom_histogram(aes(x=fare_amount),bins =30, fill="darkblue") +
  theme_bw()
```

* I guess we can kind of see most fares are between 0 - 100.
* Hard to tell where the main distribution is spread around.
* We can enhance this using a log transformation.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
df$transform_fare_amount <- log(df$fare_amount)
ggplot(df)+
  geom_histogram(aes(x=transform_fare_amount),bins = 30, fill="darkblue") +
  theme_bw()
```

* Take a log transformation to visually see the distribution

Do a correlation check.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
cor(df$trip_distance,df$fare_amount,method = "pearson")
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
library(pheatmap)
#remove characters
pheatmap(cor(df[,-c(1:3,9)]),
         cluster_rows = FALSE,
         cluster_cols = FALSE)
```

* trip_distance highly correlates with high tips, tolls and overall trip amount
* payment_type seems to have some form of negative correlation with tip_amount. Must be careful as this is a discrete category.


```{r }
cors =c("passenger_count", "trip_distance", "fare_amount", "extra", 
 "mta_tax", "tip_amount", "tolls_amount", "improvement_surcharge", "total_amount")
cor(df[,cors])
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
pheatmap(cor(df[,cors]))
```

Other plots to present correlations.

```{r}
library(corrplot)
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
corrplot(cor(df[,cors]), method = 'number')
```
```{r message=FALSE, warning=FALSE, fig.align = "center"}
corrplot(cor(df[,cors]), method = 'color', order = 'alphabet') 
```
'AOE' is for the angular order of the eigenvectors.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
corrplot(cor(df[,cors]), method = 'color', order = 'AOE')  # after 'AOE' reorder
```

[More references to draw cor plots.](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html)

### Study Payment type and Distance

```{r}
library(forcats)
df = df %>% 
  mutate(payment_type = as_factor(payment_type)) %>% 
  mutate(payment_type = recode(payment_type,`1` = "Credit Card", `2` = "Cash", `3` = "No charge", `4` = "Dispute"))
```

```{r}
# Check category frequencies
fct_count(df$payment_type)
```

```{r}
#Collapse Cash/No charge/Dispute
df = df %>% 
  mutate(payment_type = fct_collapse(payment_type, 
                                     Credit_Card = c("Credit Card"), 
                                     Cash_Or_Others=c("Cash","No charge","Dispute")))
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df, aes(payment_type)) + 
  geom_bar(fill=c("pink","orange")) + 
  ylab("Frequency") + 
  ggtitle("Barplot of Payment Methods")+ 
  theme_bw()
```
```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df) +
  geom_histogram(aes(x=trip_distance, fill=payment_type))+ 
  theme_bw()
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df) +
  geom_histogram(aes(x=trip_distance, fill=payment_type),
                 breaks=seq(0,20, by=1))+ 
  theme_bw()+
  scale_fill_brewer(palette = "Paired")
```
Use facets.

```{r message=FALSE, warning=FALSE, fig.align = "center",fig.height=6,fig.width=10}
ggplot(df) +
  geom_histogram(aes(x=trip_distance, fill=payment_type),
                 breaks=seq(0,20, by=1))+ 
  theme_bw()+
  facet_grid(.~payment_type) +
  scale_fill_brewer(palette = "Paired")
```

The default setting of position to draw two histgrams together is by stacking them instead of their identity.

Plot the information of payment type and trip distance together in one.

```{r message=FALSE, warning=FALSE, fig.align = "center",fig.height=6,fig.width=10}
ggplot(df) +
  geom_boxplot(aes(x=payment_type,
                  y=trip_distance,
                  fill=payment_type))+ 
  scale_y_continuous(trans='log2') +
  scale_fill_brewer(palette = "Paired") +
  theme_bw()
```


[Super useful ggplot2 cheat sheet!!](https://www.maths.usyd.edu.au/u/UG/SM/STAT3022/r/current/Misc/data-visualization-2.1.pdf)


### A brief summary

#### Visualisations

* Good visualizations vs Bad visualizastions

#### Personal Checklist for Visualisations and Dashboards:

* Your visualisation needs to tell a story.

* It should be intepretable without being overly verbose.

* The scale and axis need to make sense (and you can assume the reader knows the difference between a normal scale vs log scale).

* The choice of visualisation needs to make sense:
1. Line plot vs Bar chart with non-numerical categories
2. Scatterplot vs Histogram plot to see distribution
3. etc

* Choice of colour scheme / alpha / size need to be easy on the eyes.

At the end of the day, even if you think your visualisation is "pretty" or "beautiful", if a reader cannot understand it, then it is not a good visualisation.


### Use Spark in R

See sparklyr tutorial.


#### SessionInfo

```{r}
sessionInfo()
```