---
title: "Lab2 tutorial"
date: "`r Sys.Date()`"
author: Yue You
output:
  rmdformats::html_clean:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---


## Lab 2 Overview

### First Half

More Visualisations:

* Heatmaps

* HexBins vs SquareBins

* Choropleths

Descriptive Statistics:

* Histograms and looking at the distribution shape.

* How to "quick plot" dataframes using ggplot2.

* Some methods of determining bin sizes.

### Second Half

Revision:

* Any code related questions for R

### Let's get started

### Visualisations

* Binned plots

* Good visualizations vs Bad visualizastions

### Personal Checklist for Visualisations and Dashboards:

* Your visualisation needs to tell a story.

* It should be intepretable without being overly verbose.

* The scale and axis need to make sense (and you can assume the reader knows the difference between a normal scale vs log scale).

* The choice of visualisation needs to make sense:
1. Line plot vs Bar chart with non-numerical categories
2. Scatterplot vs Histogram plot to see distribution
3. etc

* Choice of colour scheme / alpha / size need to be easy on the eyes.

At the end of the day, even if you think your visualisation is "pretty" or "beautiful", if a reader cannot understand it, then it is not a good visualisation.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load libraries
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(sf)
library(curl)
library(ggmap)
library(tmap)
library(tmaptools)
library(feather)
```

Load data
```{r}
#try feather 
filepath = "/Volumes/you.y/MAST30034_R/data/df.feather"
df <- read_feather(filepath)
df %>% tail
```
### Heatmaps

* Excellent tool when visualising geospatial coordinates.


Select the map.

```{r, message=FALSE,warning=FALSE,fig.height = 8, fig.width = 6, fig.align = "center"}
xranges <- range(df$pickup_longitude[!df$pickup_longitude==0])
yranges <- range(df$pickup_latitude[!df$pickup_latitude==0])
xranges
yranges
```


```{r, message=FALSE,warning=FALSE, fig.align = "center"}
map_big <- get_stamenmap(
  rbind(-74.3,40.45,-73.75,40.95), 
  zoom = 10)
ggmap(map_big)
```

Plot pickup locations

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  geom_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) 
```

Change the color scale.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) +
  scale_fill_viridis_c(trans = "log10")
```

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude),
             bins=50) +
  scale_fill_gradientn(colours = c("darkred", "orange", "yellow", "white"),trans="log10")
```

Filled by discrete factors.

```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 fill = as.factor(passenger_count)),
             bins=50) 
```
Change the color palette. A good palette makes your story better.

```{r message=FALSE, fig.align = "center"}
library(RColorBrewer)
display.brewer.all()
```
```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 fill = as.factor(payment_type)),
             bins=100) +
  scale_fill_brewer(palette = "Dark2")
```



```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_bin2d(data = df,
             aes(x = pickup_longitude,
                 y = pickup_latitude,
                 fill = as.factor(payment_type),
                 alpha = 0.95),
             bins=100) +
  scale_fill_brewer(palette = "Dark2")
```


Hexagon bins avoid the visual artefacts sometimes generated by the very regular alignment of geom_bin2d().


Plot HexBin.
```{r, message=FALSE, warning=FALSE, fig.align = "center"}
ggmap(map_big) + 
  stat_binhex(data=df,
           aes(x = pickup_longitude, y = pickup_latitude),
               bins=100) +
  coord_cartesian()  +
  scale_fill_gradient2(trans="log10")
```

```{r, message=FALSE, warning=FALSE, fig.align = "center",fig.height=6,fig.width=15}
ggmap(map_big) + 
  stat_binhex(data=df,
           aes(x = pickup_longitude, y = pickup_latitude),
           alpha = 0.9,
           bins=100) +
  coord_cartesian()  +
  scale_fill_viridis_c(trans = "log10") +
  facet_grid(.~payment_type)
```


### Shapefile Overlays

* **NOTE: This only applies on the more recent datasets that use zones over coordinates**

Requirements:

geopandas

Shapefile Links:

[linked phrase](https://s3.amazonaws.com/nyc-tlc/misc/taxi_zones.zip)
[linked phrase](https://s3.amazonaws.com/nyc-tlc/misc/taxi+_zone_lookup.csv)


```{r}
df_yellow = read.csv("/Volumes/you.y/MAST30034_R/data/yellow_tripdata_2019-01.csv",stringsAsFactors = TRUE)
df_yellow %>% 
  group_by(PULocationID,passenger_count) %>% 
  summarise(n=sum(passenger_count)) -> df_yellow_summary
```

```{r}
library(sf)
```

```{r}
sf = st_read("/Volumes/you.y/MAST30034_R/data/shapefile/taxi_zones/taxi_zones.shp")
zone = read.csv("/Volumes/you.y/MAST30034_R/data/shapefile/taxi+_zone_lookup.csv")
```

Basic information in shapefile.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
sf = st_read("/Volumes/you.y/MAST30034_R/data/shapefile/taxi_zones/")
plot(sf)
```
** Choropleth with ggplot **

```{r  message=FALSE, warning=FALSE, fig.align = "center"}
ggplot() + 
  geom_sf(data = sf, size = 1, color = "black", fill = "cyan1") + 
  ggtitle("Boundary Plot") + 
  coord_sf()+
  theme_bw()
```

** Choropleth with tmap **

tmap is specifically designed to make creation of thematic maps more convenient. It borrows from thw ggplot syntax and takes care of a lot of the styling and aesthetics. This reduces our amount of code significantly. We only need:

* tm_shape() where we provide the sf object (we could also provide an SpatialPolygonsDataframe)

*tm_polygons() where we set the attribute variable to map, the break style, and a title.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
tm_shape(sf)+
   tm_polygons("Shape_Area",style="quantile")
```

** Web mapping with leaflet **


```{r}
library(leaflet) 
```

Incorporate the information we have.

```{r}
df_yellow_summary$LocationID <- df_yellow_summary$PULocationID
full_join(sf,df_yellow_summary,by="LocationID") -> sf_full
```

While tmap was tolerant about our AEA projection of philly_crimes_sf, leaflet does require us to explicitly reproject the sf object.


```{r message=FALSE, warning=FALSE, fig.align = "center"}
# reproject
sf_WGS84 <- st_transform(sf_full, 4326)
leaflet(sf_WGS84) %>%
  addPolygons()
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
sf_WGS84 %>% filter(!is.na(n)) ->sf_plot
pal_fun <- colorQuantile("YlOrRd", NULL, n = 5)
p_popup <- paste0("<strong>Passanger number: </strong>", sf_plot$n)
leaflet(sf_plot) %>%
  addPolygons(
    stroke = FALSE, 
    fillColor = ~pal_fun(n),
    fillOpacity = 0.8, smoothFactor = 0.5,
    popup = p_popup) %>%
  addTiles() %>%
  addLegend("bottomright",  # location
            pal=pal_fun,    # palette function
            values=~n,  # value to be passed to palette function
            title = 'Passanger number') # legend title
```



### Descriptive Statistics

```{r}
filepath = "/Volumes/you.y/MAST30034_R/data/df.feather"
df <- read_feather(filepath)
```

```{r}
summary(df)
```
Remember that not all the data should be interpreted as purely numerical.
There may be conclusions you can draw by coincidence if you incorrectly assume data types!
For example:
* longitude and latitude should be interpreted as geospatial coordinates
* payment_type is a discrete category of payment types
* trip_distance is non-linear (not a straight line from A to B), but we have no further data on it. It is also in miles.
* To avoid misinterpreting the attributes, refer to the data dictionary provided on the TLC website.

### Scatterplot plots for Fare / Distance

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df) +
  aes(x=fare_amount,y=trip_distance) +
  geom_point()+
  theme_bw()
```

General Inference:

* We can visually see that the relationship is relatively linear as you'd expect (more distance generally means more money)
* A fair number of outliers, notably around the 0 distance axis and 0 cost axis. Why might this be the case?
* Why are there negative values?



### Histgram plots for Trip Distance

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df)+
  geom_histogram(aes(x=fare_amount),bins = 30) +
  theme_bw()
```

* I guess we can kind of see most fares are between 0 - 100.
* Hard to tell where the main distribution is spread around.
* We can enhance this using a log transformation.

```{r message=FALSE, warning=FALSE, fig.align = "center"}
df$transform_fare_amount <- log(df$fare_amount)
ggplot(df)+
  geom_histogram(aes(x=transform_fare_amount),bins = 30) +
  theme_bw()
```
* Take a log transformation to visually see the distribution


How about the distribution for trips under 15 miles?

```{r message=FALSE, warning=FALSE, fig.align = "center"}
ggplot(df %>% filter(trip_distance <=15))+
  geom_histogram(aes(x=transform_fare_amount),bins = 30) +
  theme_bw()
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
df %>% 
  mutate(trip_dist_15 = ifelse(trip_distance>15,"yes","no")) %>% 
  ggplot()+
  geom_histogram(aes(x=transform_fare_amount,
                     fill=trip_dist_15),
                 bins = 30) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw()
```
```{r message=FALSE, warning=FALSE, fig.align = "center"}
cor(df$trip_distance,df$fare_amount,method = "pearson")
```

```{r message=FALSE, warning=FALSE, fig.align = "center"}
library(pheatmap)
#remove characters
pheatmap(cor(df[,-c(1:3,9)]),
         cluster_rows = FALSE,
         cluster_cols = FALSE)
```

* trip_distance highly correlates with high tips, tolls and overall trip amount
* payment_type seems to have some form of negative correlation with tip_amount. Must be careful as this is a discrete category.


```{r }
cors =c("passenger_count", "trip_distance", "fare_amount", "extra", 
 "mta_tax", "tip_amount", "tolls_amount", "improvement_surcharge", "total_amount")
cor(df[,cors])


```
```{r message=FALSE, warning=FALSE, fig.align = "center"}
pheatmap(cor(df[,cors]))
```

### Use Spark in R

See sparklyr tutorial.